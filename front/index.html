
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bsnco spei</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark: #020315;
      --bg-dark-2: #071028;
      --card-dark: rgba(255,255,255,0.03);
      --muted-dark: #97a6b8;
      --primary-blue: #1366ff;
      --accent-teal: #00c3a7;
      --text-light: #ffffff;

      --bg-light: #f6f8fb;
      --card-light: #ffffff;
      --muted-light: #6b7280;
      --primary-blue-dark: #0b4db2;
      --text-dark: #0b1220;
    }

    #a11yBtn {
    position: fixed;
    left: 16px;
    bottom: 16px;
    z-index: 10050;    
    }
    .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
    }


    html,body { height:100%; }
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:flex-start; justify-content:center; padding:28px;
      transition: background-color .22s ease, color .22s ease;
      overflow-x:hidden; max-width:100vw;
    }
    .app { width:420px; max-width: calc(100% - 40px); }

    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; width:100%; }
    .brand { display:flex; gap:12px; align-items:center; }

    .logo { width:52px; height:52px; border-radius:12px; display:flex; align-items:center; justify-content:center; transition: background .18s ease; flex-shrink:0; position:relative; overflow:hidden; }
    .logo.card { padding:0; border:none; box-shadow:none; }

    #brandLogo { width:52px; height:52px; }
    #brandLogo img{
      position:absolute;
      top:50%; left:50%;
      width:140%; height:140%;
      object-fit:contain;
      transform:translate(-50%,-50%) scale(1.9); 
      transform-origin:center;
      display:block;
    }

    .brand-title { font-weight:800; font-size:16px; line-height:1; }
    .brand-sub { font-size:12px; color:rgba(0,0,0,0.55); margin-top:2px; }

    .card { border-radius:14px; padding:16px; border:1px solid rgba(0,0,0,0.04); box-shadow: 0 10px 30px rgba(2,6,23,0.06); transition: background .22s, color .22s, border-color .22s; }

    .btn { border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; border:none; }
    .btn-primary { background:linear-gradient(180deg,var(--primary-blue), #0d58d1); color:white; box-shadow: 0 8px 20px rgba(13,88,209,0.12); }
    .btn-outline { background:transparent; border:1px solid rgba(0,0,0,0.06); color:inherit; }
    .btn-ghost { background:transparent; color:inherit; }
    .btn-disabled{opacity:.45; cursor:not-allowed; }

    input[type="text"], input[type="password"], input[type="email"], input[type="tel"], input[type="number"], select {
      width:100%; padding:10px 12px; border-radius:10px; outline:none; border:1px solid rgba(0,0,0,0.06); background:transparent; transition: border-color .18s, box-shadow .18s;
    }
    input::placeholder { color:rgba(0,0,0,0.35); }
    input:focus { border-color: #3B82F6; box-shadow: 0 0 0 4px rgba(59,130,246,0.18); outline: none; }

    .hidden { display:none !important; }

    /* Light */
    body.light { background: linear-gradient(180deg,var(--bg-light), #eef2f7); color: var(--text-dark); }
    body.light .card { background: var(--card-light); border-color: rgba(11,18,32,0.04); }
    body.light .logo { background: linear-gradient(180deg,#f8fafc,#eef3ff); border-color: rgba(11,18,32,0.06); }
    body.light input { border:1px solid rgba(11,18,32,0.06); background: #ffffff; color:var(--text-dark); }
    body.light .brand-sub { color:var(--muted-light); }
    body.light .btn-primary { background: linear-gradient(180deg,var(--primary-blue-dark), #083d90); color:white; }
    body.light #chatWindow { border-color: rgba(11,18,32,0.06); background: #fff; }

    /* Dark */
    body.dark { background: radial-gradient(900px 500px at 10% 10%, rgba(27,38,56,0.12), transparent 12%), linear-gradient(180deg,#020315,var(--bg-dark)); color: var(--text-light); }
    body.dark .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-color: rgba(255,255,255,0.04); color:var(--text-light); }
    body.dark .logo { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-color: rgba(255,255,255,0.03); color:var(--text-light); }
    body.dark input { border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:var(--text-light); }
    body.dark .brand-sub { color:var(--muted-dark); }
    body.dark .btn-primary { background: linear-gradient(180deg,var(--primary-blue), #0d58d1); color:white; }
    body.dark #chatWindow { border-color: rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(3,7,12,0.95), rgba(2,4,7,0.95)); }

    /* C√°mara */
    #cameraContainer { position: relative; width: 100%; padding-top: 75%; background-color: #000; border-radius: 0.75rem; overflow: hidden; }
    #cameraFeed { position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; border-radius:inherit; transform: scaleX(-1); }
    #cameraOverlay { position:absolute; top:0; left:0; width:100%; height:100%; border-top: 50px solid rgba(0,0,0,0.6); border-bottom: 50px solid rgba(0,0,0,0.6); border-left: 20px solid rgba(0,0,0,0.6); border-right: 20px solid rgba(0,0,0,0.6); box-shadow: 0 0 0 3px rgba(34,197,94,0.8); border-radius:inherit; pointer-events:none; }
    #voiceGuidance { position:absolute; bottom:60px; left:8px; right:8px; width:auto; text-align:center; color:#fff; font-size:1rem; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.5); padding:10px 14px; background:rgba(0,0,0,0.28); border-radius:0.6rem; }
    #subtitles { position: absolute; top: 12px; left: 12px; right: 12px; text-align:center; color: #fff; font-size:0.95rem; font-weight:600; text-shadow: 0 2px 6px rgba(0,0,0,0.6); padding:8px 12px; background: rgba(0,0,0,0.28); border-radius: 8px; }

    /* Wallet */
    .wallet-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .wallet-amount{font-size:28px;font-weight:800;letter-spacing:.2px}
    .wallet-eye{border:none;background:transparent;cursor:pointer;padding:6px 8px;border-radius:10px}
    .wallet-eye:hover{background:rgba(0,0,0,.06)}
    body.dark .wallet-eye:hover{background:rgba(255,255,255,.06)}

    .cardsWrap{position:relative;margin-top:10px}
    .cardsScroller{display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;scroll-snap-type:x mandatory}
    .cardsScroller::-webkit-scrollbar{height:8px}
    .cardsScroller::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:8px}
    body.dark .cardsScroller::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18)}

    .scrollBtn{position:absolute;top:50%;transform:translateY(-50%);border:none;border-radius:999px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,.15);background:#fff;opacity:.95}
    body.dark .scrollBtn{background:rgba(255,255,255,.1);color:#fff}
    .scrollLeft{left:-6px}
    .scrollRight{right:-6px}

    .wallet-card{min-width:290px;max-width:290px;scroll-snap-align:start;border-radius:16px;padding:16px;border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 30px rgba(2,6,23,.06);transition:transform .18s ease, box-shadow .18s ease, border-color .22s ease}
    .wallet-card:focus-visible{outline:3px solid rgba(19,102,255,.5)}
    .wallet-card.active{transform:translateY(-2px);box-shadow:0 16px 42px rgba(2,6,23,.12);border-color:rgba(19,102,255,.35)}
    body.light .wallet-card{background:linear-gradient(180deg,#ffffff,#f5f8ff)}
    body.dark .wallet-card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border-color:rgba(255,255,255,.06)}

    .card-row{display:flex;align-items:center;justify-content:space-between}
    .card-title{font-weight:800}
    .card-sub{opacity:.8;font-size:12px}
    .badge{font-size:11px;font-weight:700;padding:4px 8px;border-radius:9999px}
    .badge-debit{background:rgba(20,160,120,.12);border:1px solid rgba(20,160,120,.25)}
    .badge-credit{background:rgba(13,88,209,.12);border:1px solid rgba(13,88,209,.25)}
    .amt-lg{font-size:20px;font-weight:800}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.12);opacity:.9}
    body.dark .pill{border-color:rgba(255,255,255,.2)}
    .eye-btn { border:none; background:transparent; cursor:pointer; font-size:14px; }

    /* Avatar Chat */
    #chatAvatar { animation: bob 3.2s ease-in-out infinite; }
    @keyframes bob { 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(-3px) } }
    #eyeL, #eyeR { transform-origin: center; animation: blink 6s infinite; }
    @keyframes blink { 0%, 97%, 100% { transform: scaleY(1) } 98% { transform: scaleY(0.05) } }

    #avatarBalloon { animation: pop .24s ease-out; }
    @keyframes pop { from { transform: scale(.96); opacity:.0 } to { transform: scale(1); opacity:1 } }

    body.dark #chatWindow { border-color: rgba(255,255,255,0.08); background: rgba(3,7,12,0.95); }
    body.dark #chatAvatar { filter: saturate(1.05); }

    /* Chat bubbles */
    #chatMessages{display:flex;flex-direction:column}
    .chat-bubble{max-width:90%;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.3}
    .chat-user{align-self:flex-end;background:#2563eb;color:#fff;border:1px solid rgba(0,0,0,0.06)}
    .chat-ai{align-self:flex-start;background:rgba(0,0,0,0.06)}
    .chat-ai-typing{align-self:flex-start;opacity:.8;font-style:italic}
    body.dark .chat-ai{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08)}

    .services-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}

    #chatWindow{
      position:fixed !important;
      right:20px; bottom:88px;
      width:min(360px, calc(100vw - 24px));
      max-height:min(72vh, 560px);
      overflow:hidden;
      z-index: 9999;
      border:1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      backdrop-filter: blur(2px);
    }
    #chatMessages{
      max-height: calc(min(72vh, 560px) - 96px);
      overflow-y:auto;
    }
    #chatAvatar{ z-index: 10000; }
  </style>
</head>
<body>
  <div class="app">
      <div class="brand">
        <div id="brandLogo" class="logo card" aria-hidden="true">
          <img id="mifLogo" src="./assets/mif-logo.jpeg?v=8" alt="MIF">
        </div>
        <div>
          <div id="brandTitle" class="brand-title" style="color: var(--primary-blue);">MIF</div>
          <div id="brandSub" class="brand-sub">Mexicana Interconexion Financiera</div>
          <button id="voiceAssistToggle" class="btn btn-outline" style="position:fixed; left:20px; bottom:20px; z-index:999999; background:white;"> Accesibilidad üîä
</button>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="themeToggle" class="btn btn-outline" aria-pressed="false">Modo oscuro</button>
      </div>

    <!-- TODO: el resto debe quedar DENTRO de .app para no descuadrar -->
    <div id="authWrapper">
      <div id="loginCard" class="card">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div style="font-weight:800;font-size:18px;">Iniciar Sesi√≥n</div>
            <div style="font-size:13px; opacity:.85;">Accede para ver tu panel</div>
          </div>
          <div>
            <button id="goToRegisterBtn" class="btn btn-ghost" type="button">Registrarse</button>
          </div>
        </div>
        <form id="loginForm" class="space-y-3" aria-labelledby="loginTitle">
          <input type="text" id="loginUsername" name="username" placeholder="Usuario" required />
          <input type="password" id="loginPassword" name="password" placeholder="Contrase√±a" required />
          <div class="flex gap-2">
            <button type="submit" class="btn btn-primary flex-1">Iniciar Sesi√≥n</button>
            <button id="openRegisterPanel" type="button" class="btn btn-outline">¬øNo tienes cuenta?</button>
          </div>

          <div class="mt-4 pt-2 border-t" style="border-color: rgba(0,0,0,0.04);">
            <div class="text-sm font-semibold" style="opacity:.85">Panel Admin (Demo)</div>
            <div class="mt-2 flex gap-2 items-center">
              <input id="adminCurpLogin" type="text" placeholder="Pega el CURP" />
              <button id="adminApproveButtonLogin" class="btn btn-primary" type="button">Aprobar</button>
            </div>
          </div>
        </form>
      </div>

      <div id="registerCard" class="card hidden">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div style="font-weight:800;font-size:18px;">Crear Cuenta</div>
            <div style="font-size:13px; opacity:.85;">Reg√≠strate en unos pasos</div>
          </div>
          <div>
            <button id="backToLoginBtn" class="btn btn-ghost" type="button">Volver</button>
          </div>
        </div>

        <form id="registerForm">
          <div id="registerStep1" class="register-step">
            <label for="regCurp" class="block text-sm font-medium">CURP</label>
            <div class="flex gap-2">
              <input type="text" id="regCurp" placeholder="CURP (18 caracteres)" class="uppercase" required />
              <button type="button" id="micCurp" class="btn btn-outline">üé§</button>
            </div>

            <div class="mt-3 flex items-start gap-2 text-sm">
              <input id="regConsent" type="checkbox" class="mt-1" />
              <label for="regConsent">
                He le√≠do y acepto los <a href="#" id="termsLink" class="underline">t√©rminos de vinculaci√≥n y consulta de datos</a>.
              </label>
            </div>

            <div class="mt-3">
              <button type="button" id="regStep1Next" class="btn btn-primary w-full" disabled>Siguiente</button>
            </div>
          </div>

          <div id="registerStep2" class="register-step hidden mt-3">
            <label class="block text-sm font-medium">Datos personales</label>
            <div class="mt-2 space-y-2">
              <input type="text" id="regFechaNacimiento" readonly disabled placeholder="Fecha de nacimiento" />
              <input type="text" id="regSexo" readonly disabled placeholder="Sexo" />
              <input type="text" id="regNombre" placeholder="Nombre completo" required />
              <input type="text" id="regRfc" placeholder="RFC" class="uppercase" required />
              <input type="tel" id="regTelefono" placeholder="Tel√©fono" required />
              <input type="email" id="regCorreo" placeholder="tu@correo.com" />
              <div class="flex gap-2">
                <button type="button" id="regStep2Back" class="btn btn-outline flex-1">Atr√°s</button>
                <button type="button" id="regStep2Next" class="btn btn-primary flex-1">Siguiente</button>
              </div>
            </div>
          </div>

          <div id="registerStep3" class="register-step hidden mt-3">
            <label class="block text-sm font-medium">Cuenta</label>
            <div class="mt-2 space-y-2">
              <input type="text" id="regUsername" placeholder="usuario_demo" required />
              <input type="password" id="regPassword" placeholder="Contrase√±a (m√≠n 8)" required />
              <div class="flex items-center gap-2">
                <input id="regAccesibilidad" type="checkbox" />
                <label for="regAccesibilidad">Necesito verificaci√≥n accesible</label>
              </div>
              <div class="flex gap-2">
                <button type="button" id="regStep3Back" class="btn btn-outline flex-1">Atr√°s</button>
                <button type="submit" id="regSubmit" class="btn btn-primary flex-1">Finalizar Registro</button>
              </div>
            </div>
          </div>
        </form>

        <div class="mt-3 pt-3 border-t" style="border-color: rgba(0,0,0,0.04);">
          <div class="font-semibold text-sm">Panel Admin (Demo)</div>
          <div class="mt-2 flex gap-2">
            <input id="adminCurpRegister" type="text" placeholder="Pega el CURP" />
            <button id="adminApproveButtonRegister" class="btn btn-primary" type="button">Aprobar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboardCard" class="card hidden mt-4">
      <div class="flex items-center justify-between">
        <h3 style="font-weight:800;font-size:16px;">Bienvenido, <span id="welcomeUser" class="text-primary"></span></h3>
        <div class="flex items-center gap-2">
          <button id="logoutButton" class="btn btn-outline" type="button">Cerrar Sesi√≥n</button>
        </div>
      </div>
      <div id="saldoPanel" class="mt-4 hidden">
        <div class="balance-title">Saldo Disponible</div>
        <div class="flex items-center gap-2">
          <div id="saldoDisplay" class="balance-amount">$ -.--</div>
          <button id="toggleBalanceBtn" class="eye-btn" title="Mostrar/Ocultar">üëÅÔ∏è</button>
        </div>
        <div class="mt-3 flex gap-3">
          <button id="getSaldoButton" class="btn btn-primary flex-1" type="button">Actualizar</button>
          <button id="getSaldoAudioButton" class="btn btn-outline" type="button">Escuchar</button>
        </div>
      </div>

      <div class="mt-4 pt-3 border-t" style="border-color: rgba(0,0,0,0.04);">
        <div class="wallet-header">
          <div>
            <div class="text-xs opacity-80">Total en cuentas</div>
            <div class="wallet-amount">
              <span id="walletTotal" data-real="$ -.--">$ -.--</span>
              <button id="walletEye" class="wallet-eye" title="Mostrar/Ocultar total">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="scrollLeft" class="scrollBtn scrollLeft" aria-label="Anterior">‚Äπ</button>
            <button id="scrollRight" class="scrollBtn scrollRight" aria-label="Siguiente">‚Ä∫</button>
          </div>
        </div>

        <div class="cardsWrap">
          <div id="walletCards" class="cardsScroller" tabindex="0" aria-label="Tarjetas del wallet"></div>
        </div>
      </div>
        <div class="mt-4">
        <button id="otrosServiciosBtn" class="btn btn-outline w-full" type="button" aria-expanded="false" aria-controls="otrosServiciosPanel">
          Otros servicios
        </button>
        <div id="otrosServiciosPanel" class="hidden mt-3 services-grid" role="region" aria-label="Otros servicios">
          <button id="serviciosSeguroBtn" class="btn btn-outline">Seguro</button>
          <button id="serviciosHipotecasBtn" class="btn btn-outline btn-disabled" disabled title="Pr√≥ximamente">Hipotecas</button>
          <button id="serviciosInversionesBtn" class="btn btn-outline btn-disabled" disabled title="Pr√≥ximamente">Inversiones</button>
          <button id="serviciosCreditoBtn" class="btn btn-outline btn-disabled" disabled title="Pr√≥ximamente">Cr√©dito personal</button>
        </div>

        <button id="transferToggleBtn" class="btn btn-outline w-full mt-3" type="button" aria-expanded="false" aria-controls="transferPanel">
          Transferencia
        </button>
        <div id="transferPanel" class="hidden mt-3">
          <div class="pt-3 border-t" style="border-color: rgba(0,0,0,0.04);">
            <div class="font-semibold text-sm mb-2">Nueva Transferencia (SPEI)</div>
            <form id="transferForm" class="space-y-2">
              <input id="transferCurp" type="text" placeholder="CURP del destinatario" />
              <input id="transferMonto" type="number" step="0.01" placeholder="Monto (ej: 50.00)" />
              <div class="flex items-center gap-2">
                <input id="transferToken" type="text" placeholder="Token de seguridad (64 hex)" class="flex-1" />
                <button id="fillLocalToken" type="button" class="btn btn-outline">üìã Token local</button>
              </div>
              <p id="tokenHint" class="text-xs opacity-70">Tu token es el hash SHA-256 de tu RFC (64 caracteres hexadecimales).</p>
              <button type="submit" class="btn btn-primary w-full">Enviar Dinero</button>
            </form>
            <div id="transferError" class="text-sm text-red-600 mt-2 hidden"></div>
            <div id="transferOk" class="text-sm text-green-600 mt-2 hidden"></div>
          </div>
        </div>
      </div>
      <div class="mt-4 pt-3 border-t" style="border-color: rgba(0,0,0,0.04);">
        <div class="font-semibold text-sm">Panel Admin (Demo)</div>
        <div class="mt-2 flex gap-2">
          <input id="adminCurpDashboard" type="text" placeholder="Pega el CURP" />
          <button id="adminApproveButtonDashboard" class="btn btn-primary" type="button">Aprobar</button>
        </div>
      </div>
    </div>
    <div id="uploadIdPage" class="card hidden mt-4">
      <h3 style="font-weight:800">Subir Identificaci√≥n</h3>
      <div id="rfcTokenPanel" class="mt-3 p-3 rounded-lg hidden" style="border:1px solid rgba(0,0,0,0.08);">
        <div class="font-semibold mb-1">Tu token de seguridad</div>
        <p class="text-sm opacity-80">Gu√°rdalo. Lo necesitar√°s para transferencias y validaciones.</p>
        <div class="mt-2 flex gap-2 items-center">
          <input id="rfcTokenField" type="text" readonly class="flex-1" style="font-family:monospace" />
          <button id="copyRfcTokenBtn" type="button" class="btn btn-outline">Copiar</button>
        </div>
      </div>

      <form id="uploadIdForm" class="mt-3">
        <input type="hidden" id="uploadCurp" />
        <label class="block text-sm font-medium mb-1">Subir imagen o PDF</label>
        <input id="uploadFile" type="file" accept="image/png,image/jpeg,application/pdf" />

        <div class="mt-3 flex flex-col sm:flex-row gap-2">
          <button type="submit" class="btn btn-primary flex-1">Subir y Continuar</button>
          <button id="openCameraButton" type="button" class="btn btn-outline flex-1">Usar c√°mara</button>
        </div>
      </form>

      <div id="cameraContainer" class="hidden mt-4" aria-live="polite">
        <div id="subtitles" class="hidden" aria-hidden="false"></div>
        <video id="cameraFeed" autoplay playsinline></video>
        <div id="cameraOverlay"></div>
        <div id="voiceGuidance" class="hidden">Alinea tu INE dentro del marco verde.</div>
      </div>

      <div id="cameraActions" class="hidden mt-3 flex gap-2">
        <button id="captureButton" type="button" class="btn btn-primary flex-1">Capturar</button>
        <button id="closeCameraButton" type="button" class="btn btn-outline flex-1">Cancelar</button>
      </div>
    </div>

    <div id="segurosCard" class="card hidden mt-4">
      <div class="flex items-center justify-between">
        <h3 style="font-weight:800;font-size:16px;">Seguros ‚Äî Selecciona tu aseguradora</h3>
        <button id="volverDashboardSeguros" class="btn btn-outline" type="button">Volver</button>
      </div>

      <p class="text-sm opacity-80 mt-2">Revisa los detalles y contrata con un clic.</p>

      <div class="mt-3 space-y-3">
        <details class="rounded-lg border p-3">
          <summary class="cursor-pointer font-semibold">Aseguradora Atlas ‚Äî Plan Esencial</summary>
          <div class="mt-2 text-sm">
            <ul class="list-disc pl-5 space-y-1">
              <li>Cobertura: Vida + Accidentes</li>
              <li>Suma asegurada: $500,000 MXN</li>
              <li>Pago mensual estimado: $299 MXN</li>
            </ul>
            <div class="mt-3 flex items-center gap-2">
              <input type="radio" name="planSeguro" id="planAtlas" value="atlas_esencial">
              <label for="planAtlas">Seleccionar</label>
            </div>
            <button data-contratar="atlas_esencial" class="btn btn-primary mt-2">Contratar</button>
          </div>
        </details>

        <details class="rounded-lg border p-3">
          <summary class="cursor-pointer font-semibold">Seguros Quetzal ‚Äî Plan Plus</summary>
          <div class="mt-2 text-sm">
            <ul class="list-disc pl-5 space-y-1">
              <li>Cobertura: Vida + Gastos M√©dicos Mayores</li>
              <li>Suma asegurada: $1,200,000 MXN</li>
              <li>Pago mensual estimado: $699 MXN</li>
            </ul>
            <div class="mt-3 flex items-center gap-2">
              <input type="radio" name="planSeguro" id="planQuetzal" value="quetzal_plus">
              <label for="planQuetzal">Seleccionar</label>
            </div>
            <button data-contratar="quetzal_plus" class="btn btn-primary mt-2">Contratar</button>
          </div>
        </details>

        <details class="rounded-lg border p-3">
          <summary class="cursor-pointer font-semibold">Protec MX ‚Äî Plan Total</summary>
          <div class="mt-2 text-sm">
            <ul class="list-disc pl-5 space-y-1">
              <li>Cobertura: Vida + Accidentes + Enfermedades</li>
              <li>Suma asegurada: $2,500,000 MXN</li>
              <li>Pago mensual estimado: $1,299 MXN</li>
            </ul>
            <div class="mt-3 flex items-center gap-2">
              <input type="radio" name="planSeguro" id="planProtec" value="protec_total">
              <label for="planProtec">Seleccionar</label>
            </div>
            <button data-contratar="protec_total" class="btn btn-primary mt-2">Contratar</button>
          </div>
        </details>
      </div>
    </div>
  </div> <!-- cierre de .app -->

  <div id="chatAvatar"
       class="fixed right-5 bottom-5 z-[90] w-16 h-16 rounded-full cursor-pointer select-none"
       title="Habla con tu asistente SPEI" aria-label="Abrir chat">
    <svg id="chatAvatarSvg" viewBox="0 0 120 120" class="w-full h-full">
      <defs>
        <radialGradient id="faceGrad" cx="50%" cy="45%" r="60%">
          <stop offset="0%" stop-color="#2dd4bf"/>
          <stop offset="100%" stop-color="#0ea5e9"/>
        </radialGradient>
        <filter id="glow">
          <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="#0ea5e9" flood-opacity="0.6"/>
        </filter>
      </defs>
      <circle id="faceCircle" cx="60" cy="60" r="58" fill="url(#faceGrad)" filter="url(#glow)"/>
      <ellipse id="eyeL" cx="42" cy="52" rx="6" ry="8" fill="#001A2E"/>
      <ellipse id="eyeR" cx="78" cy="52" rx="6" ry="8" fill="#001A2E"/>
      <path id="mouth" d="M40 78 Q60 90 80 78" stroke="#001A2E" stroke-width="6" fill="none" stroke-linecap="round"/>
    </svg>
    <div id="avatarBalloon"
         class="hidden absolute -top-3 right-20 max-w-56 px-3 py-2 rounded-xl text-sm shadow-lg"
         style="background:rgba(2,6,23,.92); color:#fff; border:1px solid rgba(255,255,255,.12)">
      <span id="avatarBalloonText">¬øTe ayudo con una transferencia?</span>
    </div>
  </div>

  <div id="chatWindow" class="hidden">
    <div class="chat-header flex items-center justify-between px-3 py-2" style="font-weight:700;">
      Asistente SPEI
      <div class="flex items-center gap-3">
        <label class="text-xs flex items-center gap-1 opacity-80">
          <input id="proactiveToggle" type="checkbox" class="accent-blue-600" checked>
          Proactivo
        </label>
        <label class="text-xs flex items-center gap-1 opacity-80">
          <input id="llmToggle" type="checkbox" class="accent-blue-600" checked>
          LLM
        </label>
        <button id="closeChatButton" class="btn btn-outline" type="button">Cerrar</button>
      </div>
    </div>
    <div id="chatMessages" class="max-h-80 overflow-y-auto p-3 flex flex-col gap-2"></div>
    <form id="chatForm" class="p-3 border-t flex gap-2" style="border-color: rgba(0,0,0,0.04);">
      <input id="chatInput" type="text" placeholder="Escribe: saldo, total, cuentas, ayuda transferencia..." />
      <button type="submit" class="btn btn-primary">Enviar</button>
    </form>
  </div>

  <audio id="ttsAudio" preload="auto" playsinline></audio>

<script>
const API_URL = 'http://localhost:8000';
const CHAT_API_URL = 'http://localhost:8787';

/* --- ACCESIBILIDAD FLOTANTE SIN REFLUJOS --- */
(function(){
  // Bot√≥n flotante (fuera del flujo => no descompone layout)
  const a11yBtn = document.createElement('button');
  a11yBtn.id = 'a11yBtn';
  a11yBtn.type = 'button';
  a11yBtn.className = 'btn btn-outline';
  document.body.appendChild(a11yBtn);

  // Regi√≥n aria-live invisible (no ocupa espacio)
  const live = document.createElement('div');
  live.id = 'a11yLive';
  live.className = 'sr-only';
  live.setAttribute('aria-live', 'polite');
  live.setAttribute('aria-atomic', 'true');
  document.body.appendChild(live);

  // Estado persistente
  let a11yOn = JSON.parse(localStorage.getItem('a11y_on') || 'false');
  updateBtn();

  a11yBtn.addEventListener('click', () => {
    a11yOn = !a11yOn;
    localStorage.setItem('a11y_on', JSON.stringify(a11yOn));
    updateBtn();
    if (a11yOn) {
      try { speakOnce?.('Modo accesibilidad activado'); } catch {}
    } else {
      try { window.speechSynthesis?.cancel(); } catch {}
    }
  });

  function updateBtn(){
    a11yBtn.textContent = a11yOn ? 'Accesibilidad: ON üîä' : 'Accesibilidad: OFF üîá';
    a11yBtn.setAttribute('aria-pressed', String(a11yOn));
  }

  // Anunciador seguro (no genera reflujo)
  function announce(text){
    if (!a11yOn) return;
    live.textContent = '';               // fuerza actualizaci√≥n
    setTimeout(()=>{ live.textContent = text; }, 10);
    try { speakOnce?.(text); } catch {}
  }

  // Lectura al enfocar elementos interactivos (sin a√±adir nodos al DOM principal)
  const focusableSel = 'input,button,a,select,textarea,[tabindex]:not([tabindex="-1"])';
  function bindFocusReads(root = document){
    root.querySelectorAll(focusableSel).forEach(el=>{
      el.addEventListener('focus', ()=>{
        if (!a11yOn) return;
        const txt = el.getAttribute('aria-label')
          || el.placeholder
          || (el.textContent || '').trim()
          || el.getAttribute('title')
          || 'Elemento';
        announce(txt);
      }, {capture:true});
    });
  }
  bindFocusReads();

  const mo = new MutationObserver(()=> bindFocusReads());
  mo.observe(document.body, { childList:true, subtree:true });

/* --- Resto del JS original, sin cambios funcionales --- */

async function sha256Hex(str){
  const enc = new TextEncoder().encode((str||'').trim());
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

const body = document.body;
const themeToggle = document.getElementById('themeToggle');
function applyTheme(mode) {
  if (mode === 'light') {
    body.classList.remove('dark'); body.classList.add('light');
    themeToggle.textContent = 'Modo oscuro'; themeToggle.setAttribute('aria-pressed','false');
  } else {
    body.classList.remove('light'); body.classList.add('dark');
    themeToggle.textContent = 'Modo claro'; themeToggle.setAttribute('aria-pressed','true');
  }
  localStorage.setItem('spei_theme', mode);
}
applyTheme(localStorage.getItem('spei_theme') || 'light');
themeToggle.addEventListener('click', ()=> {
  const current = localStorage.getItem('spei_theme') || 'light';
  applyTheme(current === 'light' ? 'dark' : 'light');
});

const loginCard = document.getElementById('loginCard');
const registerCard = document.getElementById('registerCard');
const dashboardCard = document.getElementById('dashboardCard');
const uploadIdPageEl = document.getElementById('uploadIdPage');
const segurosCard = document.getElementById('segurosCard');
function showOnly(el) {
  [loginCard, registerCard, dashboardCard, uploadIdPageEl, segurosCard].forEach(x => x && x.classList.add('hidden'));
  if (el) el.classList.remove('hidden');
}
showOnly(loginCard);

function ensureUploadCurpPrefilled() {
  const hid = document.getElementById('uploadCurp');
  if (!hid) return;
  const v = (hid.value || '').trim().toUpperCase();
  if (v && v.length === 18) return;
  const last = (localStorage.getItem('spei_last_curp') || '').trim().toUpperCase();
  if (last && last.length === 18) {
    hid.value = last;
  }
}

const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const goToRegisterBtn = document.getElementById('goToRegisterBtn');
const openRegisterPanel = document.getElementById('openRegisterPanel');
const backToLoginBtn = document.getElementById('backToLoginBtn');

const regStep1Next = document.getElementById('regStep1Next');
const regStep2Back = document.getElementById('regStep2Back');
const regStep2Next = document.getElementById('regStep2Next');
const regStep3Back = document.getElementById('regStep3Back');

const adminApproveButtonLogin = document.getElementById('adminApproveButtonLogin');
const adminApproveButtonRegister = document.getElementById('adminApproveButtonRegister');
const adminApproveButtonDashboard = document.getElementById('adminApproveButtonDashboard');

const getSaldoButton = document.getElementById('getSaldoButton');
const getSaldoAudioButton = document.getElementById('getSaldoAudioButton');
const saldoDisplay = document.getElementById('saldoDisplay');
const welcomeUser = document.getElementById('welcomeUser');

const uploadIdForm = document.getElementById('uploadIdForm');
const openCameraButton = document.getElementById('openCameraButton');
const cameraContainer = document.getElementById('cameraContainer');
const cameraFeed = document.getElementById('cameraFeed');
const cameraActions = document.getElementById('cameraActions');
const captureButton = document.getElementById('captureButton');
const closeCameraButton = document.getElementById('closeCameraButton');
const subtitlesEl = document.getElementById('subtitles');
const voiceGuidance = document.getElementById('voiceGuidance');

const ttsAudio = document.getElementById('ttsAudio');

const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');

const registerSteps = {
  1: document.getElementById('registerStep1'),
  2: document.getElementById('registerStep2'),
  3: document.getElementById('registerStep3'),
};
goToRegisterBtn?.addEventListener('click', ()=> { showOnly(registerCard); });
openRegisterPanel?.addEventListener('click', ()=> { showOnly(registerCard); });
backToLoginBtn?.addEventListener('click', ()=> { showOnly(loginCard); });
function showRegisterStep(step) {
  Object.values(registerSteps).forEach(s => s && s.classList.add('hidden'));
  const t = registerSteps[step]; if (t) { t.classList.remove('hidden'); t.scrollIntoView({behavior:'smooth', block:'center'}); }
}
showRegisterStep(1);

function decodeCURP(curp) {
  if (!curp || curp.length !== 18) return null;
  try {
    const y = parseInt(curp.substring(4,6),10);
    const month = curp.substring(6,8);
    const day = curp.substring(8,10);
    const sexoChar = curp.substring(10,11).toUpperCase();
    const year = y <= 24 ? 2000 + y : 1900 + y;
    const sexo = sexoChar === 'H' ? 'Hombre' : 'Mujer';
    return { fecha: `${day}/${month}/${year}`, sexo };
  } catch { return null; }
}

function handleRegisterStep1() {
  const curpEl = document.getElementById('regCurp');
  const consentEl = document.getElementById('regConsent');
  const curp = (curpEl.value || '').toUpperCase().trim();

  if (curp.length !== 18) {
    alert('CURP inv√°lido (18 caracteres).');
    curpEl.focus();
    return;
  }
  if (!consentEl.checked) {
    alert('Debes aceptar los t√©rminos de vinculaci√≥n y consulta de datos para continuar.');
    consentEl.focus();
    return;
  }

  const d = decodeCURP(curp);
  if (!d) {
    alert('No se pudo interpretar la fecha/sexo del CURP.');
    return;
  }

  document.getElementById('regFechaNacimiento').value = d.fecha;
  document.getElementById('regSexo').value = d.sexo;

  window.__registrationData = { curp };
  localStorage.setItem('spei_last_curp', curp);

  showRegisterStep(2);
}
regStep1Next?.addEventListener('click', handleRegisterStep1);

const regCurpEl = document.getElementById('regCurp');
const regConsentEl = document.getElementById('regConsent');
function updateStep1Button() {
  const okCurp = (regCurpEl.value || '').trim().length === 18;
  const okConsent = !!regConsentEl.checked;
  regStep1Next.disabled = !(okCurp && okConsent);
}
regCurpEl?.addEventListener('input', updateStep1Button);
regConsentEl?.addEventListener('change', updateStep1Button);
updateStep1Button();

// --- Normalizaci√≥n CURP (NUEVO) ---
regCurpEl?.addEventListener('input', (e)=>{
  const v = (e.target.value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,18);
  if (v !== e.target.value) e.target.value = v;
  updateStep1Button();
});

// --- MIC CURP (NUEVO) ---
const micCurpBtn = document.getElementById('micCurp');
function normalizeCURPFromSpeech(text=''){
  // Quita espacios, guiones y s√≠mbolos; queda A-Z/0-9 en may√∫sculas
  return text.normalize('NFKD')
    .replace(/[^\w]/g,'')
    .toUpperCase()
    .replace(/_/g,'')
    .replace(/[^A-Z0-9]/g,'')
    .slice(0,18);
}
function startCURPSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('Tu navegador no soporta dictado por voz.'); return; }
  try { window.speechSynthesis.cancel(); } catch {}
  const r = new SR();
  r.lang = 'es-MX';
  r.interimResults = false;
  r.maxAlternatives = 1;
  r.onstart = ()=> { micCurpBtn.disabled = true; micCurpBtn.textContent = 'üé§‚Ä¶'; };
  r.onresult = (ev)=>{
    const text = (ev.results?.[0]?.[0]?.transcript || '').trim();
    const curp = normalizeCURPFromSpeech(text);
    if (curp.length < 18) {
      // Si qued√≥ corto, no bloqueamos; el usuario puede corregir
      regCurpEl.value = curp;
      updateStep1Button();
      alert('Revisa el dictado: parece incompleto. Corrige manualmente si es necesario.');
      return;
    }
    regCurpEl.value = curp;
    updateStep1Button();
  };
  r.onerror = ()=> { alert('No se pudo capturar el dictado. Intenta de nuevo.'); };
  r.onend = ()=> { micCurpBtn.disabled = false; micCurpBtn.textContent = 'üé§'; };
  r.start();
}
micCurpBtn?.addEventListener('click', startCURPSpeech);

async function showRfcToken(token){
  const panel = document.getElementById('rfcTokenPanel');
  const field = document.getElementById('rfcTokenField');
  if (panel && field){
    field.value = token || '';
    panel.classList.remove('hidden');
  }
}
function handleRegisterStep2() {
  const nombre = document.getElementById('regNombre').value;
  const rfc = (document.getElementById('regRfc').value || '').toUpperCase();
  if (!nombre || rfc.length < 12) return;
  (async ()=>{
    try{
      const h = await sha256Hex(rfc);
      localStorage.setItem('spei_rfc_hash', h);
      window.__rfcHash = h;
    }catch{}
  })();
  window.__registrationData = {
    ...window.__registrationData,
    nombre, rfc,
    telefono: document.getElementById('regTelefono').value,
    correo: document.getElementById('regCorreo').value || null
  };
  showRegisterStep(3);
}
regStep2Back?.addEventListener('click', ()=> showRegisterStep(1));
regStep2Next?.addEventListener('click', handleRegisterStep2);
regStep3Back?.addEventListener('click', ()=> showRegisterStep(2));

let jwtToken = null;
loginForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = (loginUsername.value || '').trim();
  const password = (loginPassword.value || '').trim();

  const fd = new URLSearchParams();
  fd.append('username', username);
  fd.append('password', password);
  fd.append('grant_type', 'password');

  let data = null;
  let ok = false;
  try {
    const res = await fetch(`${API_URL}/login/`, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: fd
    });
    ok = res.ok;
    data = ok ? await res.json() : null;
  } catch (err) {
    console.error('login fetch error', err);
  }

  if (ok && data?.access_token) {
    jwtToken = data.access_token;
    localStorage.setItem('spei_jwt', jwtToken);
    welcomeUser.textContent = username || '';
    showOnly(dashboardCard);
    await handleGetSaldo();
    await initWallet();
  } else {
    alert('Usuario o contrase√±a incorrectos');
  }
});

const savedJwt = localStorage.getItem('spei_jwt');
if (savedJwt) {
  window.__rfcToken = localStorage.getItem('spei_rfc_token') || null;
  jwtToken = savedJwt;
  showOnly(dashboardCard);
  handleGetSaldo().then(initWallet);
}

const registerFormEl = document.getElementById('registerForm');
registerFormEl?.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const username = document.getElementById('regUsername').value?.trim();
  const password = document.getElementById('regPassword').value?.trim();
  const accesibilidad = document.getElementById('regAccesibilidad').checked;

  if (!username || username.length < 5) return;
  if (!password || password.length < 8) return;

  const curpUI   = document.getElementById('regCurp')?.value?.toUpperCase()?.trim();
  const nombreUI = document.getElementById('regNombre')?.value?.trim();
  const rfcUI    = document.getElementById('regRfc')?.value?.toUpperCase()?.trim();
  const telUI    = document.getElementById('regTelefono')?.value?.trim();
  const mailUI   = document.getElementById('regCorreo')?.value?.trim() || null;

  const base = window.__registrationData || {};
  const payload = {
    curp: (base.curp || curpUI || '').toUpperCase(),
    nombre: base.nombre || nombreUI,
    rfc: (base.rfc || rfcUI || '').toUpperCase(),
    telefono: base.telefono || telUI,
    correo: base.correo ?? mailUI,
    username,
    password
  };

  if (!payload.curp || payload.curp.length !== 18) return;
  if (!payload.nombre) return;
  if (!payload.rfc || payload.rfc.length < 12) return;
  if (!payload.telefono) return;

  const rfcToken = await sha256Hex(payload.rfc);
  window.__rfcToken = rfcToken;
  localStorage.setItem('spei_rfc_token', rfcToken);

  let res, data = {};
  try {
    res = await fetch(`${API_URL}/registrar/?accesibilidad=${accesibilidad}`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    try { data = await res.json(); } catch {}
  } catch {}

  if (payload.correo) {
    try {
      await fetch(`${API_URL}/token_email`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ to: payload.correo, token: rfcToken })
      });
    } catch {}
  }

  const curpForUpload = (data.curp || payload.curp || '').toUpperCase();
  localStorage.setItem('spei_last_curp', curpForUpload);

  if (curpForUpload) {
    document.getElementById('uploadCurp').value = curpForUpload;
    showOnly(uploadIdPageEl);
    await showRfcToken(window.__rfcToken);
    ensureUploadCurpPrefilled();
  } else {
    showOnly(loginCard);
  }
});

uploadIdForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const curp = (document.getElementById('uploadCurp').value || '').toUpperCase().trim();
  const file = document.getElementById('uploadFile').files[0];

  if (!curp) { alert('Falta CURP (el sistema lo pone al registrarte).'); return; }
  if (!file) { alert('Selecciona una imagen o PDF de tu identificaci√≥n.'); return; }

  const formData = new FormData();
  formData.append('curp', curp);
  formData.append('file', file);

  let res, txt;
  try {
    res = await fetch(`${API_URL}/cargar_id/`, { method:'POST', body: formData });
    txt = await res.text();
  } catch (err) {
    console.error('[upload] network error', err);
    alert('Error de red al subir la identificaci√≥n (revisa CORS/puerto del front).');
    return;
  }

  if (res.ok) {
    try { const data = JSON.parse(txt); console.log('[upload] OK', data); } catch {}
    alert('Identificaci√≥n recibida. Quedar√° en revisi√≥n. Ahora vuelve a la pantalla de inicio de sesi√≥n.');
    showOnly(loginCard);
    return;
  }

  let msg = 'No se pudo subir la identificaci√≥n.';
  try {
    const j = JSON.parse(txt);
    if (j?.detail) msg = j.detail;
  } catch {}

  if (res.status === 400) {
    msg += ' (Posible causa: el usuario no est√° en estado PENDIENTE_REGISTRO o el CURP no coincide).';
  }
  alert(msg);
});

document.getElementById('copyRfcTokenBtn')?.addEventListener('click', async ()=>{
  const v = document.getElementById('rfcTokenField').value;
  try { await navigator.clipboard.writeText(v); } catch {}
});

async function handleApprove(curp) {
  if (!curp) { alert('Pega un CURP v√°lido.'); return false; }
  try {
    const res = await fetch(`${API_URL}/admin/aprobar/?curp=${encodeURIComponent(curp.toUpperCase().trim())}`, { method: 'POST' });
    const raw = await res.text();
    if (!res.ok) {
      alert(`No se pudo aprobar.\nStatus: ${res.status}\nRespuesta: ${raw}`);
      return false;
    }
    alert(' Usuario aprobado y activado.');
    return true;
  } catch (e) {
    alert('Error de red al aprobar.');
    return false;
  }
}
document.getElementById('adminApproveButtonLogin')?.addEventListener('click', async ()=>{
  const curp = document.getElementById('adminCurpLogin').value; const ok = await handleApprove(curp);
  if (ok) document.getElementById('adminCurpLogin').value = '';
});
document.getElementById('adminApproveButtonRegister')?.addEventListener('click', async ()=>{
  const curp = document.getElementById('adminCurpRegister').value; const ok = await handleApprove(curp);
  if (ok) document.getElementById('adminCurpRegister').value = '';
});
document.getElementById('adminApproveButtonDashboard')?.addEventListener('click', async ()=>{
  const curp = document.getElementById('adminCurpDashboard').value; const ok = await handleApprove(curp);
  if (ok) document.getElementById('adminCurpDashboard').value = '';
});

let balanceVisible = true;
const toggleBalanceBtn = document.getElementById('toggleBalanceBtn');
toggleBalanceBtn?.addEventListener('click', ()=>{
  balanceVisible = !balanceVisible;
  renderSaldoText();
});
function renderSaldoText() {
  const txt = saldoDisplay.getAttribute('data-real') || '$ -.--';
  if (!balanceVisible) saldoDisplay.textContent = txt.replace(/\d/g, '‚Ä¢');
  else saldoDisplay.textContent = txt;
}
async function handleGetSaldo() {
  saldoDisplay.textContent = 'Cargando...';
  try {
    const opts = { credentials: 'include', headers: {} };
    if (jwtToken) opts.headers['Authorization'] = `Bearer ${jwtToken}`;
    const res = await fetch(`${API_URL}/saldo/me`, opts);
    if (!res.ok) { saldoDisplay.textContent = '$ -.--'; return; }
    const data = await res.json();
    const pretty = `$ ${Number(data.saldo||0).toFixed(2)}`;
    saldoDisplay.setAttribute('data-real', pretty);
    renderSaldoText();
  } catch {
    saldoDisplay.textContent = '$ -.--';
  }
}
document.getElementById('getSaldoButton')?.addEventListener('click', handleGetSaldo);

let audioCtx=null, currentSource=null;
async function playBuffer(ab){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(currentSource){try{currentSource.stop(0);}catch{} currentSource=null;}
  const buffer=await audioCtx.decodeAudioData(ab.slice(0));
  const src=audioCtx.createBufferSource(); src.buffer=buffer; src.connect(audioCtx.destination); currentSource=src; src.start(0);
}
async function playTTSProtected(url, token){
  try{
    const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});
    if(!res.ok) throw 0;
    const ab=await res.arrayBuffer();
    try { await playBuffer(ab); return; } catch{
      const blob=new Blob([ab],{type:'audio/mpeg'}); const u=URL.createObjectURL(blob);
      const ttsAudio=document.getElementById('ttsAudio');
      ttsAudio.pause(); ttsAudio.currentTime=0; ttsAudio.src=u;
      await new Promise((ok,err)=>{
        const r=()=>{cleanup(); ok()};
        const e=()=>{cleanup(); err()};
        function cleanup(){ttsAudio.removeEventListener('canplaythrough',r); ttsAudio.removeEventListener('error',e);}
        ttsAudio.addEventListener('canplaythrough',r,{once:true});
        ttsAudio.addEventListener('error',e,{once:true});
      });
      await ttsAudio.play(); ttsAudio.onended=()=>{try{URL.revokeObjectURL(u);}catch{}};
    }
  }catch{}
}
document.getElementById('getSaldoAudioButton')?.addEventListener('click', async ()=>{
  if(!jwtToken) return;
  await playTTSProtected(`${API_URL}/saldo/audio/me`, jwtToken);
});

const walletCardsEl = document.getElementById('walletCards');
const walletTotalEl = document.getElementById('walletTotal');
const walletEyeBtn = document.getElementById('walletEye');
const scrollLeftBtn = document.getElementById('scrollLeft');
const scrollRightBtn = document.getElementById('scrollRight');

let walletTotalVisible = true;
function renderWalletTotalText(){
  const real = walletTotalEl.getAttribute('data-real') || '$ -.--';
  walletTotalEl.textContent = walletTotalVisible ? real : real.replace(/\d/g,'‚Ä¢');
}
walletEyeBtn?.addEventListener('click', ()=>{
  walletTotalVisible = !walletTotalVisible;
  renderWalletTotalText();
});
scrollLeftBtn?.addEventListener('click', ()=>{
  walletCardsEl.scrollBy({left: -300, behavior:'smooth'});
});
scrollRightBtn?.addEventListener('click', ()=>{
  walletCardsEl.scrollBy({left: 300, behavior:'smooth'});
});
function renderWalletCard(c, idx){
  const isDeb = c.tipo === 'debito';
  const div = document.createElement('div');
  div.className = 'wallet-card';
  div.setAttribute('tabindex','0');
  div.setAttribute('role','group');
  div.setAttribute('aria-label', `${c.alias} ${isDeb?'D√©bito':'Cr√©dito'}`);
  if(idx===0) div.classList.add('active');

  div.innerHTML = `
    <div class="card-row">
      <div>
        <div class="card-title">${c.alias || (isDeb?'Cuenta d√©bito':'Tarjeta cr√©dito')}</div>
        <div class="card-sub">${c.numero || ''}</div>
      </div>
      <span class="badge ${isDeb?'badge-debit':'badge-credit'}">${isDeb?'D√©bito':'Cr√©dito'}</span>
    </div>

    <div class="mt-4">
      <div style="font-size:12px;opacity:.85">${isDeb?'Disponible':'Disponible (cr√©dito)'}</div>
      <div class="amt-lg">${(c.disponible != null ? ('$ ' + Number(c.disponible).toFixed(2)) : '-')}</div>
    </div>

    <div class="mt-3 grid grid-cols-2 gap-8 text-sm">
      <div>
        <div style="opacity:.8">${isDeb ? 'Saldo' : 'Adeudo actual'}</div>
        <div class="font-semibold">${(c.saldo != null ? ('$ ' + Number(c.saldo).toFixed(2)) : '-')}</div>
      </div>
      <div>
        <div style="opacity:.8">${isDeb ? 'Moneda' : 'L√≠mite'}</div>
        <div class="font-semibold">${isDeb ? (c.moneda||'MXN') : ('$ ' + Number(c.limite||0).toFixed(2))}</div>
      </div>
    </div>

    ${Array.isArray(c.tags) && c.tags.length ? `
      <div class="mt-3 flex gap-2 flex-wrap">
        ${c.tags.map(t=>`<span class="pill">${t}</span>`).join('')}
      </div>` : ``}
  `;

  div.addEventListener('click', ()=>{
    document.querySelectorAll('.wallet-card.active').forEach(n=>n.classList.remove('active'));
    div.classList.add('active');
    div.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  });

  return div;
}
async function initWallet(){
  try{
    const opts = { credentials:'include', headers: {} };
    if (jwtToken) opts.headers['Authorization'] = `Bearer ${jwtToken}`;
    if (window.__rfcHash) opts.headers['X-RFC-Hash'] = window.__rfcHash;

    const res = await fetch(`${API_URL}/mis_cuentas`, opts);
    const raw = await res.text();
    let data = null;
    try { data = JSON.parse(raw); } catch (e) { console.warn('[wallet] Raw:', raw); }

    if (!res.ok || !data) throw new Error(`[wallet] status=${res.status}`);

    window.__walletCache = {
      total_disponible: Number(data.total_disponible||0),
      cuentas: Array.isArray(data.cuentas)? data.cuentas : []
    };

    refreshAvatarMood(window.__walletCache.total_disponible);

    const totalTxt = `$ ${Number(data.total_disponible || 0).toFixed(2)}`;
    walletTotalEl.setAttribute('data-real', totalTxt);
    renderWalletTotalText();

    walletCardsEl.innerHTML = '';
    (data.cuentas || []).forEach((c, i) => walletCardsEl.appendChild(renderWalletCard(c, i)));

    if (!data.cuentas || data.cuentas.length === 0) console.info('[wallet] sin cuentas');

  } catch (err){
    console.error('[wallet] initWallet fallback:', err);
    const demo = {
      total_disponible: 1234.56,
      cuentas: [
        { tipo:'debito',  alias:'Cuenta N√≥mina', numero:'**** 1234', disponible: 934.12, saldo: 934.12, moneda:'MXN', tags:['Principal'] },
        { tipo:'credito', alias:'Visa Oro',     numero:'**** 7788', disponible: 7800.00, saldo: 1200.00, limite: 9000.00, tags:['Domiciliado'] }
      ]
    };
    window.__walletCache = { total_disponible: demo.total_disponible, cuentas: demo.cuentas };
    refreshAvatarMood(window.__walletCache.total_disponible);

    walletTotalEl.setAttribute('data-real', `$ ${demo.total_disponible.toFixed(2)}`);
    renderWalletTotalText();
    walletCardsEl.innerHTML = '';
    demo.cuentas.forEach((c,i)=> walletCardsEl.appendChild(renderWalletCard(c,i)));
  }
}

const transferForm = document.getElementById('transferForm');
const transferError = document.getElementById('transferError');
const transferOk = document.getElementById('transferOk');
document.getElementById('fillLocalToken')?.addEventListener('click', ()=>{
  const t = localStorage.getItem('spei_rfc_token') || '';
  document.getElementById('transferToken').value = t;
});
function isHex64(s){ return /^[a-f0-9]{64}$/i.test((s||'').trim()); }
document.getElementById('transferToken')?.addEventListener('input',(e)=>{
  e.target.setCustomValidity(isHex64(e.target.value) ? '' : 'Debe ser SHA-256 (64 hex).');
});
transferForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  transferError.classList.add('hidden');
  transferOk.classList.add('hidden');
  if (!jwtToken) { transferError.textContent='Sesi√≥n inv√°lida.'; transferError.classList.remove('hidden'); return; }

  const payload = { 
    curp_destino: document.getElementById('transferCurp').value?.toUpperCase()?.trim(),
    monto: parseFloat(document.getElementById('transferMonto').value),
  };
  const token = (document.getElementById('transferToken').value||'').trim();

  if (!payload.curp_destino || payload.curp_destino.length!==18) { transferError.textContent='CURP inv√°lido.'; transferError.classList.remove('hidden'); return; }
  if (!payload.monto || payload.monto <= 0) { transferError.textContent='Monto inv√°lido.'; transferError.classList.remove('hidden'); return; }
  if (!isHex64(token)) { transferError.textContent='Token inv√°lido: debe ser SHA-256 (64 hex).'; transferError.classList.remove('hidden'); return; }

  try{
    const headers = {
      'Content-Type':'application/json',
      'Authorization': `Bearer ${jwtToken}`,
      'X-User-Token': token
    };
    if (window.__rfcHash) headers['X-RFC-Hash'] = window.__rfcHash;

    const res = await fetch(`${API_URL}/transferir/`, { 
      method:'POST', headers, body: JSON.stringify(payload) 
    });
    if (!res.ok) {
      const tx = await res.text().catch(()=> '');
      let msg = 'No se pudo completar la transferencia.';
      if (res.status===401||res.status===403) msg = 'Token inv√°lido o no coincide con el RFC registrado.';
      transferError.textContent = `${msg} ${tx?(' ‚Ä¢ '+tx):''}`;
      transferError.classList.remove('hidden');
      return;
    }
    transferForm.reset();
    transferOk.textContent = 'Transferencia enviada ‚úÖ';
    transferOk.classList.remove('hidden');
    handleGetSaldo(); initWallet();
  }catch(e){
    transferError.textContent='Error de red al transferir.';
    transferError.classList.remove('hidden');
  }
});

let cameraStream = null;
let acc_canvas = null, acc_ctx = null;
let acc_processing = false;
let stableCounter = 0;
let countdownTimer = null;
let lastState = '';
let speakCooldown = 0;
const STATE_COOLDOWN_MS = 1400;

const DETECT_CFG = {
  BRIGHTNESS_MIN: 58,
  EDGE_RATIO_MIN: 0.028,
  AREA_COVERAGE_MIN: 0.10,
  AR_MIN: 1.45, AR_MAX: 1.70,
  CENTER_TOL: 0.12,
  FRAMES_STABLE: 8,
  COUNTDOWN_MS: 2000
};

function clearSpeech(){ try { window.speechSynthesis.cancel(); } catch {} }
function speakOnce(text, opts={rate:.95, pitch:1, volume:.9, lang:'es-MX'}){
  const now = Date.now();
  if (now < speakCooldown) return;
  speakCooldown = now + STATE_COOLDOWN_MS;
  clearSpeech();
  if(!('speechSynthesis' in window)) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = opts.lang||'es-MX';
    u.rate = opts.rate??0.95; u.pitch = opts.pitch??1; u.volume = opts.volume??0.9;
    const voices = speechSynthesis.getVoices();
    const v = voices.find(vv=>String(vv.lang).toLowerCase().includes('es')) || voices[0];
    if (v) u.voice = v;
    window.speechSynthesis.speak(u);
  }catch{}
}
function showSubtitle(t){
  const el = document.getElementById('subtitles');
  el.textContent = t;
  el.classList.remove('hidden');
  setTimeout(()=>el.classList.add('hidden'), 1600);
}
function computeEdgeData(imageData, w, h){
  const data=imageData.data;
  const gray=new Uint8ClampedArray(w*h);
  for(let i=0;i<w*h;i++){
    const idx=i*4; gray[i]=(0.299*data[idx]+0.587*data[idx+1]+0.114*data[idx+2]);
  }
  const gx=[-1,0,1,-2,0,2,-1,0,1], gy=[-1,-2,-1,0,0,0,1,2,1];
  const edges=new Uint8ClampedArray(w*h);
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let sx=0, sy=0, k=0;
      for(let ky=-1; ky<=1; ky++){
        for(let kx=-1; kx<=1; kx++){
          const val=gray[(y+ky)*w+(x+kx)];
          sx += gx[k]*val; sy += gy[k]*val; k++;
        }
      }
      const mag = Math.hypot(sx,sy);
      edges[y*w+x] = mag>120 ? 255 : 0;
    }
  }
  return edges;
}
function accessibleProcessFrame(){
  const cameraFeed = document.getElementById('cameraFeed');
  if(!acc_processing || !cameraFeed || cameraFeed.readyState<2){ requestAnimationFrame(accessibleProcessFrame); return; }
  const vw=cameraFeed.videoWidth, vh=cameraFeed.videoHeight;
  if(!vw||!vh){ requestAnimationFrame(accessibleProcessFrame); return; }

  const sampleW=240, sampleH=Math.round(sampleW*(vh/vw));
  acc_canvas.width=sampleW; acc_canvas.height=sampleH;
  acc_ctx.drawImage(cameraFeed,0,0,sampleW,sampleH);
  const img=acc_ctx.getImageData(0,0,sampleW,sampleH);

  const cx0=Math.floor(sampleW*0.18), cy0=Math.floor(sampleH*0.18);
  const cx1=Math.floor(sampleW*0.82), cy1=Math.floor(sampleH*0.82);
  let sum=0,count=0;
  for(let y=cy0;y<cy1;y+=2){ for(let x=cx0;x<cx1;x+=2){
    const idx=(y*sampleW+x)*4;
    sum += 0.299*img.data[idx]+0.587*img.data[idx+1]+0.114*img.data[idx+2];
    count++;
  }}
  const avgBright = sum / Math.max(1,count);

  const edges = computeEdgeData(img, sampleW, sampleH);

  let minX=sampleW, minY=sampleH, maxX=0, maxY=0, edgeCount=0;
  for(let y=cy0;y<cy1;y++){
    for(let x=cx0;x<cx1;x++){
      const v=edges[y*sampleW+x];
      if(v>0){
        edgeCount++;
        if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y;
      }
    }
  }
  const centralArea=(cx1-cx0)*(cy1-cy0);
  const edgeRatio=edgeCount/Math.max(1,centralArea);
  const bboxW=Math.max(0,maxX-minX), bboxH=Math.max(0,maxY-minY);
  const bboxArea=bboxW*bboxH, areaCoverage=bboxArea/(sampleW*sampleH);
  const ar = bboxH>0 ? bboxW/bboxH : 0;

  const centerX=(minX+maxX)/2, centerY=(minY+maxY)/2;
  const frameCenterX=sampleW/2, frameCenterY=sampleH/2;
  const dxRel=Math.abs(centerX-frameCenterX)/sampleW;
  const dyRel=Math.abs(centerY-frameCenterY)/sampleH;
  const centeredOk = dxRel <= DETECT_CFG.CENTER_TOL && dyRel <= DETECT_CFG.CENTER_TOL;

  const brightOk = avgBright >= DETECT_CFG.BRIGHTNESS_MIN;
  const edgeOk = edgeRatio >= DETECT_CFG.EDGE_RATIO_MIN;
  const areaOk = areaCoverage >= DETECT_CFG.AREA_COVERAGE_MIN;
  const arOk = ar >= DETECT_CFG.AR_MIN && ar <= DETECT_CFG.AR_MAX;

  let stateMsg = '';
  if(!brightOk) stateMsg = 'No hay suficiente luz. Ac√©rcate a una fuente de luz.';
  else if(bboxW===0||bboxH===0) stateMsg = 'No detecto la credencial. Sost√©nla frente a la c√°mara.';
  else if(!arOk) stateMsg = 'Ajusta el √°ngulo: mant√©n la credencial paralela a la c√°mara.';
  else if(!areaOk) stateMsg = 'Acerca un poco la credencial.';
  else if(!edgeOk) stateMsg = 'Mant√©n firme la credencial unos segundos.';
  else if(!centeredOk){
    const msgX = centerX>frameCenterX ? 'a la izquierda' : 'a la derecha';
    const msgY = centerY>frameCenterY ? 'hacia arriba' : 'hacia abajo';
    stateMsg = `Mueve un poco ${msgX} y ${msgY}.`;
  } else stateMsg = 'Perfecto. Mant√©nte inm√≥vil.';

  if(stateMsg !== lastState){
    speakOnce(stateMsg);
    showSubtitle(stateMsg);
    lastState = stateMsg;
  }

  if(brightOk && edgeOk && areaOk && arOk && centeredOk){
    stableCounter++;
    if(stableCounter === 2) { showSubtitle('Perfecto. No te muevas.'); }
    if(stableCounter >= DETECT_CFG.FRAMES_STABLE && !countdownTimer){
      speakOnce('Capturar√© la foto en 3 segundos.');
      setTimeout(()=>speakOnce('3'), 600);
      setTimeout(()=>speakOnce('2'), 1200);
      setTimeout(()=>speakOnce('1'), 1800);
      countdownTimer = setTimeout(()=>{ autoCaptureAndUpload(); countdownTimer=null; stableCounter=0; }, DETECT_CFG.COUNTDOWN_MS);
    }
  } else {
    stableCounter = 0;
    if(countdownTimer){ clearTimeout(countdownTimer); countdownTimer=null; }
  }

  if(acc_processing) requestAnimationFrame(accessibleProcessFrame);
}
document.getElementById('openCameraButton')?.addEventListener('click', async ()=>{
  try{
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    document.getElementById('cameraFeed').srcObject = cameraStream;
    document.getElementById('cameraContainer').classList.remove('hidden');
    document.getElementById('cameraActions').classList.remove('hidden');

    acc_canvas = document.createElement('canvas');
    acc_ctx = acc_canvas.getContext('2d');
    acc_processing = true;
    stableCounter = 0; lastState='';
    speakOnce('Coloca tu INE dentro del marco. Te ir√© guiando.');
    requestAnimationFrame(accessibleProcessFrame);
  }catch{}
});
document.getElementById('closeCameraButton')?.addEventListener('click', ()=>{
  acc_processing=false; stableCounter=0; lastState='';
  if(countdownTimer){clearTimeout(countdownTimer); countdownTimer=null;}
  if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null;}
  document.getElementById('cameraFeed').srcObject=null;
  document.getElementById('cameraContainer').classList.add('hidden');
  document.getElementById('cameraActions').classList.add('hidden');
  clearSpeech();
});
document.getElementById('captureButton')?.addEventListener('click', ()=> {
  if(!document.getElementById('cameraFeed').srcObject) return;
  captureAndSendFrame();
});
function captureAndSendFrame(){
  const cameraFeed = document.getElementById('cameraFeed');
  const w=cameraFeed.videoWidth, h=cameraFeed.videoHeight;
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.save(); ctx.scale(-1,1); ctx.drawImage(cameraFeed,-w,0,w,h); ctx.restore();
  canvas.toBlob(async (blob)=>{
    const curp=document.getElementById('uploadCurp').value;
    if(!blob||!curp) return;
    const fd=new FormData(); fd.append('curp',curp); fd.append('file',blob,'captura_ine.jpg');
    try{
      const res=await fetch(`${API_URL}/cargar_id/`,{method:'POST', body:fd});
      if(!res.ok) return;
      speakOnce('Tu identificaci√≥n se ha enviado correctamente. Gracias.');
      document.getElementById('closeCameraButton').click();
      showOnly(loginCard);
    }catch{}
  }, 'image/jpeg', 0.95);
}
function autoCaptureAndUpload(){ captureAndSendFrame(); }

const chatAvatar = document.getElementById('chatAvatar');
const chatWindow = document.getElementById('chatWindow');
const closeChatButton = document.getElementById('closeChatButton');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const chatMessages = document.getElementById('chatMessages');
const proactiveToggle = document.getElementById('proactiveToggle');
const llmToggle = document.getElementById('llmToggle');
const avatarBalloon = document.getElementById('avatarBalloon');
const avatarBalloonText = document.getElementById('avatarBalloonText');

if (llmToggle) llmToggle.checked = true;

function addChatMessage(msg, who='ai') {
  const div = document.createElement('div');
  div.classList.add('chat-bubble');
  if (who === 'user') div.classList.add('chat-user');
  else if (who === 'ai') div.classList.add('chat-ai');
  else div.classList.add('chat-ai-typing');
  div.textContent = msg;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function addTyping() {
  const el = document.createElement('div');
  el.classList.add('chat-bubble','chat-ai-typing');
  el.textContent = 'Escribiendo‚Ä¶';
  chatMessages.appendChild(el);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return el;
}
function openChat() { chatWindow.classList.remove('hidden'); }
function closeChat() { chatWindow.classList.add('hidden'); }

chatAvatar.addEventListener('click', ()=>{
  document.getElementById('eyeL')?.setAttribute('ry','10');
  document.getElementById('eyeR')?.setAttribute('ry','10');
  setTimeout(()=>{
    document.getElementById('eyeL')?.setAttribute('ry','8');
    document.getElementById('eyeR')?.setAttribute('ry','8');
  }, 600);

  if (chatWindow.classList.contains('hidden')) {
    openChat();
    if (!chatMessages.children.length) {
      addChatMessage('Hola, soy tu asistente. Puedo ayudarte con tu saldo, total del wallet, transferencias SPEI, token/hash y m√°s. Preg√∫ntame libremente.', 'ai');
    }
  } else {
    closeChat();
  }
});

async function askLLM(userText) {
  const w = window.__walletCache || {};
  const cuentas = Array.isArray(w.cuentas) ? w.cuentas : [];
  const total = typeof w.total_disponible === 'number' ? w.total_disponible : null;
  const saldoPretty = (document.getElementById('saldoDisplay')?.getAttribute('data-real')) || null;
  const walletPretty = (document.getElementById('walletTotal')?.getAttribute('data-real')) || null;

  const context = {
    saldo: saldoPretty,
    total_wallet: walletPretty || (total!=null ? `$ ${total.toFixed(2)}` : null),
    cuentas: cuentas,
    tips: {
      token: 'El token es SHA-256 del RFC; 64 hex.',
      transferencia: 'Se requiere CURP destino, monto y token v√°lido; enviamos X-User-Token y opcional X-RFC-Hash.'
    },
  };

  const headers = { 'Content-Type': 'application/json' };
  if (jwtToken) headers['Authorization'] = `Bearer ${jwtToken}`;

  const body = {
    q: userText,
    context,
    system: `Eres un asistente bancario que conoce el contexto del usuario (saldo, cuentas, token RFC hash).
Responde en espa√±ol, directo, √∫til y seguro. Nunca inventes saldos; usa el contexto provisto.`
  };

  const resp = await fetch(`${CHAT_API_URL}/chat`, { method:'POST', headers, body: JSON.stringify(body) });
  if (!resp.ok) throw new Error('LLM error');
  const data = await resp.json();
  if (!data || !data.answer) throw new Error('Sin respuesta');
  return data.answer;
}

function localFallback(userText) {
  const t = (userText||'').toLowerCase();
  const w = window.__walletCache || {};
  const cuentas = Array.isArray(w.cuentas)? w.cuentas : [];
  const total = typeof w.total_disponible === 'number' ? w.total_disponible : null;

  if (/saldo|balance/.test(t)) {
    const pretty = document.getElementById('saldoDisplay')?.getAttribute('data-real') || '$ -.--';
    return `Tu saldo disponible es ${pretty}.`;
  }
  if (/total|wallet|cartera/.test(t)) {
    if (total!=null) return `El total en tu wallet es $ ${total.toFixed(2)}.`;
    const pretty = document.getElementById('walletTotal')?.getAttribute('data-real') || '$ -.--';
    return `El total en tu wallet es ${pretty}.`;
  }
  if (/cuentas?|tarjetas?/.test(t)) {
    if (cuentas.length===0) return 'A√∫n no tengo tus cuentas en cach√©. Pulsa ‚ÄúActualizar‚Äù en saldo o espera unos segundos.';
    const lines = cuentas.map(c=>{
      const tipo = c.tipo==='debito'?'D√©bito':'Cr√©dito';
      const name = c.alias || (c.tipo==='debito'?'Cuenta d√©bito':'Tarjeta cr√©dito');
      const dispo = (c.disponible!=null)?`$ ${Number(c.disponible).toFixed(2)}`:'-';
      return `‚Ä¢ ${name} (${tipo}) ‚Äî Disponible: ${dispo}`;
    }).join('\n');
    return `Estas son tus cuentas:\n${lines}`;
  }
  if (/token|hash/.test(t)) {
    const tok = localStorage.getItem('spei_rfc_token');
    if (tok) return `Tu token (hash RFC) est√° guardado localmente. Debe tener 64 hex. √öltimos 6: ${tok.slice(-6)}.`;
    return 'No encuentro tu token local. Genera uno al registrarte o vuelve a registrar el RFC.';
  }
  if (/transfer(encia)?|enviar|spei/.test(t)) {
    return 'Para transferir: CURP destino (18), monto (ej. 150.00) y Token (64 hex). Pulsa üìã para pegar token local.';
  }

  return 'No pude razonar tu petici√≥n offline. Intenta de nuevo o revisa que el servidor de IA est√© arriba.';
}

const chatFormEl = document.getElementById('chatForm');
const chatInputEl = document.getElementById('chatInput');
chatFormEl?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const t = chatInputEl.value.trim();
  if (!t) return;
  addChatMessage(t,'user');
  chatInputEl.value='';
  const typing = addTyping();
  try {
    let ans;
    if (llmToggle?.checked) {
      try {
        ans = await askLLM(t);
      } catch {
        ans = localFallback(t);
      }
    } else {
      ans = localFallback(t);
    }
    typing.remove();
    addChatMessage(ans,'ai');
  } catch {
    typing.remove();
    addChatMessage('Hubo un problema al procesar tu mensaje. Intenta de nuevo.','ai');
  }
});

let proactiveTimer = null;
function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function scheduleProactive() {
  if (proactiveTimer) clearTimeout(proactiveTimer);
  const ms = 45000 + Math.random()*75000;
  proactiveTimer = setTimeout(()=>{
    if (!document.getElementById('proactiveToggle')?.checked) { scheduleProactive(); return; }
    if (document.getElementById('dashboardCard')?.classList.contains('hidden')) { scheduleProactive(); return; }
    const t = window.__walletCache?.total_disponible ?? null;
    const promptsBase = [
      '¬øQuieres revisar tu total del wallet?',
      'Puedo listar tus cuentas si lo pides.',
      '¬øNecesitas ayuda para una SPEI?',
      'Recuerda: el token es el hash de tu RFC (64 hex).',
      '¬øTe digo tu saldo disponible ahora mismo?'
    ];
    const promptsLow = [
      'Tu total se ve ajustado. ¬øRevisamos cargos recientes?',
      '¬øProgramamos un recordatorio de pago?'
    ];
    const promptsHigh = [
      'Tu total luce s√≥lido. ¬øQuieres mover a inversi√≥n?',
      '¬øAgendamos una transferencia recurrente?'
    ];
    let pool = promptsBase;
    if (typeof t==='number') {
      if (t < 100) pool = promptsLow.concat(promptsBase);
      else if (t > 5000) pool = promptsHigh.concat(promptsBase);
    }
    const avatarBalloonText = document.getElementById('avatarBalloonText');
    const avatarBalloon = document.getElementById('avatarBalloon');
    avatarBalloonText.textContent = randomFrom(pool);
    avatarBalloon.classList.remove('hidden');
    setTimeout(()=> avatarBalloon.classList.add('hidden'), 3500);
    scheduleProactive();
  }, ms);
}
scheduleProactive();

function refreshAvatarMood(total){
  const mouth = document.getElementById('mouth');
  const face = document.getElementById('faceCircle');
  if (typeof total !== 'number') {
    mouth.setAttribute('d','M40 78 Q60 90 80 78');
    face.setAttribute('filter','url(#glow)');
    return;
  }
  if (total < 100) {
    mouth.setAttribute('d','M40 86 Q60 74 80 86');
    face.setAttribute('filter','url(#glow)');
  } else if (total > 5000) {
    mouth.setAttribute('d','M38 74 Q60 98 82 74');
    face.setAttribute('filter','url(#glow)');
  } else {
    mouth.setAttribute('d','M40 78 Q60 90 80 78');
    face.setAttribute('filter','url(#glow)');
  }
}

document.getElementById('logoutButton')?.addEventListener('click', ()=>{
  jwtToken=null; localStorage.removeItem('spei_jwt');
  saldoDisplay.textContent='$ -.--'; saldoDisplay.removeAttribute('data-real');
  walletCardsEl.innerHTML=''; walletTotalEl.textContent='$ -.--'; walletTotalEl.removeAttribute('data-real');
  document.getElementById('welcomeUser').textContent='';
  showOnly(loginCard);
});

const otrosServiciosBtn = document.getElementById('otrosServiciosBtn');
const otrosServiciosPanel = document.getElementById('otrosServiciosPanel');
otrosServiciosBtn?.addEventListener('click', ()=>{
  const isHidden = otrosServiciosPanel.classList.contains('hidden');
  otrosServiciosPanel.classList.toggle('hidden', !isHidden ? true : false);
  const expanded = isHidden ? 'true' : 'false';
  otrosServiciosBtn.setAttribute('aria-expanded', expanded);
});

const transferToggleBtn = document.getElementById('transferToggleBtn');
const transferPanel = document.getElementById('transferPanel');
transferToggleBtn?.addEventListener('click', ()=>{
  const willShow = transferPanel.classList.contains('hidden');
  transferPanel.classList.toggle('hidden', !willShow ? true : false);
  transferToggleBtn.setAttribute('aria-expanded', willShow ? 'true':'false');
});

document.getElementById('serviciosSeguroBtn')?.addEventListener('click', ()=>{
  showOnly(segurosCard);
});
document.getElementById('volverDashboardSeguros')?.addEventListener('click', ()=>{
  showOnly(dashboardCard);
});

function contratarSeguro(code){
  const planMap = {
    'atlas_esencial': 'Aseguradora Atlas ‚Äî Plan Esencial',
    'quetzal_plus': 'Seguros Quetzal ‚Äî Plan Plus',
    'protec_total': 'Protec MX ‚Äî Plan Total'
  };
  const nombre = planMap[code] || code;
  const elegido = document.querySelector(`input[name="planSeguro"][value="${code}"]`);
  if (!elegido) {
    alert('Selecciona el plan dentro del desplegable antes de contratar.');
    return;
  }
  elegido.checked = true;
  alert(`‚úÖ Contrataci√≥n enviada: ${nombre}`);
  showOnly(dashboardCard);
}
document.querySelectorAll('[data-contratar]')?.forEach(btn=>{
  btn.addEventListener('click', ()=> contratarSeguro(btn.getAttribute('data-contratar')));
});

let voiceAssistEnabled = false;

const voiceBtn = document.getElementById('voiceAssistToggle');

function speak(text){
  if(!voiceAssistEnabled) return;
  if(!window.speechSynthesis) return;

  try {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-MX";
    u.rate = 1;
    u.pitch = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } catch {}
}

voiceBtn.addEventListener('click', ()=>{
  voiceAssistEnabled = !voiceAssistEnabled;
  voiceBtn.textContent = voiceAssistEnabled ? "Accesibilidad: ON üîä" : "Accesibilidad: OFF";
  speak("Modo accesibilidad activado");
});

document.querySelectorAll("input, button, a, select").forEach(el=>{
  el.addEventListener("focus", ()=>{
    const txt = el.placeholder || el.innerText || el.getAttribute("aria-label") || "";
    if(txt.length > 0) speak(txt);
  });
});

const saldoDisplayObs = new MutationObserver(()=>{
  speak("Tu saldo es " + (saldoDisplay.textContent || ""));
});
if (saldoDisplay)
  saldoDisplayObs.observe(saldoDisplay, { characterData:true, subtree:true });

})();
</script>
</body>
</html>
